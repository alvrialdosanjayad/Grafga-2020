<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Hingga Kriskurniawan</title>

    <link rel="stylesheet" href="css/style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
    <script src="js/game.js"></script>
    <script src="js/background.js"></script>
    <script src="js/assetsManager.js"></script>

    <script>
        
        $(document).ready(function () {
            $("#about-page").hide();
            $("#canvas").hide();
            $("#game-over-box").hide();
            $("#menu-level-page").hide();

            $("#start-game-button").click(function() {
                $("#menu-page").hide();
                $("#game-over-box").hide();
                $("#menu-level-page").show();
            });

            $("#level-1").click(function() {
                $("#menu-page").hide();
                $("#game-over-box").hide();
                $("#menu-level-page").hide();
                $("#canvas").show();

                var canvas = document.getElementById("canvas");
                var context = canvas.getContext("2d");
                var game = new Game(canvas, context);
                game.newGame();
                
                var jarijaribola = 20;
                xawal = Math.floor(Math.random() * (800-(2*jarijaribola))) + jarijaribola;
                yawal = Math.floor(Math.random() * (600-(2*jarijaribola))) + jarijaribola;
                wawal = "#"+((1<<24)*Math.random()|0).toString(16);
                sawal = Math.random() * 2;
                var bola = {
                    x: xawal,
                    y: yawal,
                    warna: wawal,
                    sudut: sawal,
                    offset: 0,
                    jarijari: jarijaribola,
                    nyawa: 255
                };
                /* -- struktur data objek peluru, meniru dari bola -- */
                var jarijaripeluru = 5;
                var coba;
                var peluru = [];
                function buatpeluru(xbola,ybola,sawal,offset,maju){
                    //wawal = "#"+((1<<24)*Math.random()|0).toString(16);
                    //sawal = Math.random() * 2;
                    pelor = {
                        x: xbola + 0*Math.cos(sawal * Math.PI)-maju*Math.sin(sawal * Math.PI),
                        y: ybola + 0*Math.sin(sawal * Math.PI)+maju*Math.cos(sawal *Math.PI),
                        warna: "#00aa00",
                        sudut: sawal,
                        offset: offset
                    };
                    peluru.push(pelor);
                }

                /* -- fungsi jarak Euclidean --*/
                function euDist(objek1, objek2){
                    jarak = Math.sqrt(Math.pow(objek1.x-objek2.x,2) + Math.pow(objek1.y-objek2.y,2));
                    return jarak;
                }

                /* -- nilai awal -- */

                /* -- deteksi keyboard -- */
                window.addEventListener("keydown", keydn, true);
                window.addEventListener("keyup", keyup, true);
                var yangDipencet = {};
                function keydn(e){
                    //Multi-pencet, keyCode tuts keyboard yang dipencet menjadi indeks array dengan isi elemen TRUE
                    yangDipencet[e.keyCode] = true;
                    //Bola0				
                    //arah atas
                    if(yangDipencet[38]==true) {
                        bola.offset--;
                    };
                    //arah bawah
                    if(yangDipencet[40]==true) {
                        bola.offset++;
                    };
                    //arah kiri
                    if(yangDipencet[37]==true) { 
                        bola.sudut = bola.sudut - 0.05;
                        if(bola.sudut<=0){
                            bola.sudut=2;
                        }
                    };
                    //arah kanan
                    if(yangDipencet[39]==true) { 
                        bola.sudut = bola.sudut + 0.05;
                        if(bola.sudut>=2){
                            bola.sudut=0;
                        }
                    };
                    //tembak enter
                    if(yangDipencet[32]==true) {
                        buatpeluru(bola.x,bola.y,bola.sudut,-(1+Math.abs(bola.offset)),-jarijaribola-5);
                    };
    
                }
                function keyup(e){
                    delete yangDipencet[e.keyCode];
                    //yangDipencet[e.keyCode]=false;
                }

                /* -- penggambaran dinamis -- */
                function gambarkan(){
                    context.clearRect(0,0,800,600);
                    /* background dst masuk sini */

                    /*--- Bagian bola dan cucuk ---*/

                    context.save();
                    /*--- Recolor ---*/
                    if(bola.nyawa<0){
                        bola.nyawa=0;
                    }
                    bola.warna="rgb("+String(255-bola.nyawa)+","+String(255-bola.nyawa)+",255)";
                    
                    /*--- Layer kalkulasi ---*/
                    //update nilai geseran secara kontinu
                    bola.x = bola.x + 0*Math.cos(bola.sudut * Math.PI)-bola.offset*Math.sin(bola.sudut * Math.PI);
                    if(bola.x<(0+jarijaribola)||bola.x>(800-jarijaribola)){
                            bola.offset=-bola.offset;
                    }
                    if(bola.y<(0+jarijaribola)||bola.y>(600-jarijaribola)){
                            bola.offset=-bola.offset;
                    }
                    //geser kanvas sesuai posisi koordinat bola pada sumbu 	
                    context.translate(bola.x, bola.y);
                    //rotasi hadap bola	
                    context.rotate(bola.sudut * Math.PI);
                    /*--- Layer penggambaran ---*/	
                    /* digambar bolanya */
                    context.beginPath();
                    context.arc(0,0,bola.jarijari,0,2*Math.PI, false);		//jari-jarinya 20
                    context.closePath();
                    context.fillStyle = bola.warna;
                    context.fill();
                    context.fillText(bola.nyawa,0,40);
                    /* digambar cucuknya */
                    context.beginPath();
                    context.moveTo(0,-bola.jarijari);
                    context.lineTo(10,-10);
                    context.lineTo(-10,-10);
                    context.closePath();
                    context.fillStyle = "#ffff00";
                    context.strokeStyle="#666666";
                    context.stroke();
                    context.fill();
                    context.restore();

                    //kembalikan ukuran setelah tertembak
                    if(bola.jarijari>jarijaribola){
                        bola.jarijari=jarijaribola;
                    }
                    /*--- Bagian peluru ---*/
                    if(peluru.length>0){
                        for(i=0;i<peluru.length;i++){
                            context.save();					
                            /*--- Layer kalkulasi ---*/
                            //update nilai geseran secara kontinu
                            peluru[i].x = peluru[i].x + 0*Math.cos(peluru[i].sudut * Math.PI)-peluru[i].offset*Math.sin(peluru[i].sudut * Math.PI);
                            peluru[i].y = peluru[i].y + 0*Math.sin(peluru[i].sudut * Math.PI)+peluru[i].offset*Math.cos(peluru[i].sudut *Math.PI);
                            //geser kanvas sesuai posisi koordinat bola pada sumbu 	
                            context.translate(peluru[i].x, peluru[i].y);
                            /*--- Layer penggambaran ---*/	
                            /* digambar pelurunya */
                            context.beginPath();
                            context.arc(0,0,jarijaripeluru,0,2*Math.PI, false);		
                            context.closePath();
                            context.fillStyle = peluru[i].warna;
                            context.fill();

                            /*--- Cek Collision ---*/
                            shot=false;
                            //dengan bola[0]: kalau tertembak bengkak sesaat
                            if(shot==false){
                                jb0 = euDist(peluru[i], bola)-(jarijaribola+jarijaripeluru);
                                //context.fillText(jb0,0,0);
                                if(jb0<=0){
                                    bola.jarijari = Math.round(jarijaribola*1.5);
                                    bola.nyawa--;
                                    peluru.splice(i,1);
                                    shot=true;
                                }
                            }
        
                            context.restore();
                        }
                    }
                }
                setInterval(gambarkan, 20);
            });

            $("#about-button").click(function() {
                $("#menu-page").hide();
                $("#about-page").show();
            });

            $(".back-button").click(function() {
                $("#about-page").hide();
                $("#menu-page").show();
                $("#menu-level-page").hide();
            });

            $("#exit-button").click(function() {
                var playerName = $("#name-field").val() === "" ? "unnamed" : $("#name-field").val();
                console.log(playerName + " scored " + $("#score-field").html());

                var score = {
                    points: $("#score-field").html(),
                    name: playerName
                };

                var scores = JSON.parse(localStorage.getItem("scores"));

                if (scores === null) {
                    scores = [];
                }

                scores.push(score);
                localStorage.setItem("scores", JSON.stringify(scores));

                $("#canvas").hide();
                $("#game-over-box").hide();
                $("#menu-page").show();
            });
        });
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="menu-page">
            <h1>Deadly Shooter 2020</h1>
            <ul>
                <li><a id="start-game-button" href="#">Start Game</a></li>
                <li><a id="about-button" href="#">About</a></li>
            </ul>
        </div>
        <div id="about-page">
            <h1>Nama Kelompok</h1>
            <a class="back-button" href="#">Menu</a>
            <h2>71170192 - Guntur Nawak Sara Tumakaka</h2>
            <h2>71170230 - Alvrialdo Sanjaya Dese</h2>
            <h2>71170230 - Hingga KrisKurniawan</h2>
            <p>
                Game ini sangat baik mahasiswa yang bosan dan merasa jomblo!
            </p>
        </div>
        <div id="menu-level-page">
            <h1>Deadly Shooter 2020</h1>
            <ul>
                <a id="level-1" href="#">Level 1</a>
                <br>
                <a id="level-2" href="#">Level 2</a>
                <br><br>
                <a class="back-button" href="#">Menu</a>
            </ul>
        </div>
        <canvas id="canvas" width="800" height="600">
            Your web browser does not support a canvas
        </canvas>
        <div id="game-over-box">
            <h1>Game Over</h1>
            <p id="game-over-p">Score: <span id="score-field"></span></p>
            <input type="text" id="name-field" name="name-field" placeholder="Your name" pattern="^[a-zA-Z]+$" />
            <input type="button" id="exit-button" name="exit-button" value="Exit" />
        </div>
    </div>
</body>
</html>